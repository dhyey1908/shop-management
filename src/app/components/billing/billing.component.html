<!-- Interactive Billing Screen -->
<div class="billing-container no-print">
    <div class="billing-header">
        <button class="btn btn-secondary back-btn" (click)="goBack()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor" style="width: 20px; height: 20px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            {{ 'BACK' | translate }}
        </button>
        <h2>{{ 'NEW_INVOICE_TITLE' | translate }}</h2>
        <div style="width: 80px"></div>
    </div>

    <div class="card">
        <!-- Header: Customer and Date -->
        <div class="invoice-header-row">
            <div class="form-group customer-group">
                <label>{{ 'CUSTOMER_NAME' | translate }}:</label>
                <div class="d-flex gap-2">
                    <app-searchable-dropdown [options]="customerOptions" [placeholder]="'SELECT_CUSTOMER' | translate"
                        [(ngModel)]="selectedCustomerId" (selectionChange)="onCustomerSelect($event)" style="flex: 1">
                    </app-searchable-dropdown>

                </div>
            </div>
            <div>
                <button class="btn btn-primary btn-icon" (click)="goToAddCustomer()" title="Add New Customer">
                    +
                </button>
            </div>
            <div class="form-group date-group">
                <label>{{ 'DATE' | translate }}:</label>
                <input type="date" class="form-control" [(ngModel)]="date">
            </div>
        </div>

        <!-- Table -->
        <div class="items-table-container">
            <table class="items-table">
                <thead>
                    <tr>
                        <th style="width: 40%">{{ 'ITEM_NAME' | translate }}</th>
                        <th style="width: 15%">{{ 'QUANTITY' | translate }}</th>
                        <th style="width: 20%">{{ 'PRICE' | translate }}</th>
                        <th style="width: 20%">{{ 'TOTAL' | translate }}</th>
                        <th style="width: 5%"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of items; let i = index">
                        <td>
                            <app-searchable-dropdown [options]="productOptions"
                                [placeholder]="'SELECT_PRODUCT' | translate" [(ngModel)]="item.productId"
                                (selectionChange)="onProductSelect(i, $event)">
                            </app-searchable-dropdown>
                        </td>
                        <td>
                            <input type="number" class="form-control text-center" [(ngModel)]="item.quantity"
                                (change)="updateQuantity(i, item.quantity)" min="1">
                        </td>
                        <td>
                            <input type="number" class="form-control text-right" [(ngModel)]="item.price"
                                (change)="updatePrice(i, item.price)" min="0">
                        </td>
                        <td class="text-right total-cell">
                            {{ formatCurrency(item.total) }}
                        </td>
                        <td class="text-center">
                            <button class="btn-icon btn-danger btn-sm" (click)="removeItem(i)"
                                *ngIf="items.length > 1 || item.productId" title="Remove Item">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor" style="width: 16px; height: 16px;">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="add-item-row">
                <button class="btn btn-link" (click)="addNewItemRow()">
                    + {{ 'ADD_ITEM' | translate }}
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="invoice-footer">
            <div class="totals-container">
                <div class="total-row">
                    <label>{{ 'SUBTOTAL' | translate }}:</label>
                    <span class="value">{{ formatCurrency(subtotal) }}</span>
                </div>
                <div class="total-row">
                    <label>{{ 'DISCOUNT' | translate }}:</label>
                    <div class="discount-input-group">
                        <span> % </span>
                        <input type="number" [(ngModel)]="discountPercentage" (ngModelChange)="onDiscountChange()"
                            min="0" max="100">
                    </div>
                </div>
                <div class="separator"></div>
                <div class="total-row grand-total-row">
                    <label>{{ 'GRAND_TOTAL' | translate }}:</label>
                    <span class="value">{{ formatCurrency(grandTotal) }}</span>
                </div>

                <div class="total-row"
                    style="margin-top: 10px; display: flex; align-items: center; justify-content: flex-end; gap: 10px;">
                    <label style="margin: 0;">{{ 'STATUS' | translate }}:</label>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm" [class.btn-success]="paymentStatus === 'Paid'"
                            [class.btn-outline-secondary]="paymentStatus !== 'Paid'" (click)="paymentStatus = 'Paid'">{{
                            'PAID' | translate }}</button>
                        <button type="button" class="btn btn-sm" [class.btn-warning]="paymentStatus === 'Pending'"
                            [class.btn-outline-secondary]="paymentStatus !== 'Pending'"
                            (click)="paymentStatus = 'Pending'">{{ 'PENDING' | translate }}</button>
                    </div>
                </div>
                <div class="separator"></div>
            </div>
        </div>

        <!-- Actions -->
        <div class="actions-bar">
            <button class="btn btn-primary" (click)="saveInvoice()"> {{ 'SAVE_INVOICE' | translate }}</button>
            <button class="btn btn-secondary" (click)="printInvoice()" (click)="saveInvoice()"> {{ 'PRINT' | translate }}</button>
            <button class="btn btn-outline" (click)="clearForm()"> {{ 'CLEAR' | translate }}</button>
        </div>
    </div>
</div>

<!-- Print Receipt Template -->
<div class="print-template print-only">
    <div class="print-header">
        <h1>{{ shopName || 'Shop Name' }}</h1>
        <p class="address" *ngIf="shopAddress">{{ shopAddress }}</p>
        <p class="contact">
            <span *ngIf="shopPhone">Ph: {{ shopPhone }}</span>
            <span *ngIf="shopPhone && shopEmail"> | </span>
            <span *ngIf="shopEmail">{{ shopEmail }}</span>
        </p>
        <p *ngIf="shopGST" class="gst">GSTIN: {{ shopGST }}</p>
    </div>

    <div class="invoice-details">
        <div class="customer-details">
            <label>{{ 'BILL_TO' | translate }}:</label>
            <div class="name">{{ customerName || 'Walk-in Customer' }}</div>
            <div *ngIf="customerPhone">{{ customerPhone }}</div>
            <div *ngIf="customerAddress">{{ customerAddress }}</div>
        </div>
        <div class="invoice-meta">
            <div class="row">
                <label>{{ 'INVOICE_NO' | translate }}:</label>
                <span>{{ invoiceNumber }}</span>
            </div>
            <div class="row">
                <label>{{ 'DATE' | translate }}:</label>
                <span>{{ formatDate(date) }}</span>
            </div>
        </div>
    </div>

    <table class="print-table">
        <thead>
            <tr>
                <th style="width: 45%">{{ 'ITEM_NAME' | translate }}</th>
                <th style="width: 15%" class="text-center">{{ 'QUANTITY' | translate }}</th>
                <th style="width: 20%" class="text-right">{{ 'PRICE' | translate }}</th>
                <th style="width: 20%" class="text-right">{{ 'TOTAL' | translate }}</th>
            </tr>
        </thead>
        <tbody>
            <ng-container *ngFor="let item of items">
                <tr *ngIf="item.productName">
                    <td>{{ item.productName }}</td>
                    <td class="text-center">{{ item.quantity }}</td>
                    <td class="text-right">{{ item.price }}</td>
                    <td class="text-right">{{ formatCurrency(item.total) }}</td>
                </tr>
            </ng-container>
        </tbody>
    </table>

    <div class="print-footer">
        <div class="totals-box">
            <div class="total-row">
                <label>{{ 'SUBTOTAL' | translate }}:</label>
                <span>{{ formatCurrency(subtotal) }}</span>
            </div>
            <div class="total-row" *ngIf="discountAmount > 0">
                <label>{{ 'DISCOUNT' | translate }} ({{ discountPercentage }}%):</label>
                <span>-{{ formatCurrency(discountAmount) }}</span>
            </div>
            <div class="total-row grand-total">
                <label>{{ 'GRAND_TOTAL' | translate }}:</label>
                <span>{{ formatCurrency(grandTotal) }}</span>
            </div>
        </div>
    </div>

    <div class="print-message">
        <p>{{ 'THANK_YOU' | translate }}</p>
    </div>
</div>